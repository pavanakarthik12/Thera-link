<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TheraLink - Patient Dashboard</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #f7f9fc; 
      color: #222; 
      margin: 20px; 
    }
    .card { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      margin-bottom: 20px; 
    }
    button { 
      margin: 5px; 
      padding: 6px 10px; 
      border-radius: 8px; 
      cursor: pointer; 
      border: none;
    }
    .taken { 
      background: #4CAF50; 
      color: white; 
    }
    .missed { 
      background: #E53935; 
      color: white; 
    }
    .refresh { 
      background: #2196F3; 
      color: white; 
      padding: 8px 12px; 
    }
    input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    .prescription-item {
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .prescription-item:last-child {
      border-bottom: none;
    }
    .risk-low { color: #4CAF50; }
    .risk-medium { color: #FFC107; }
    .risk-high { color: #E53935; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .patient-id-display {
      font-size: 0.9em;
      color: #666;
    }
    .error {
      color: #E53935;
      background-color: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      color: #4CAF50;
      background-color: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <h2>üë§ TheraLink Patient Dashboard</h2>
      <div class="patient-id-display" id="patientIdDisplay"></div>
    </div>
    <div id="patientInfo"></div>
    <div id="messageArea"></div>
    
    <!-- Manual patient ID input for troubleshooting -->
    <div id="manualInput" style="margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 8px; display: none;">
      <h3>Enter Patient ID Manually</h3>
      <p>If the patient link isn't working, you can enter your Patient ID below:</p>
      <input type="text" id="manualPatientId" placeholder="Enter your Patient ID" style="width: 300px; margin-right: 10px;">
      <button onclick="loadPatientManually()" style="background-color: #ff9800; color: white;">Load My Data</button>
    </div>
  </div>

  <div class="card" id="prescriptionsCard" style="display:none;">
    <h3>üíä My Prescriptions</h3>
    <div id="prescriptions"></div>
  </div>

  <div class="card" id="summaryCard" style="display:none;">
    <h3>üìä My Progress</h3>
    <p id="adherence"></p>
    <p id="risk"></p>
    <p id="feedback"></p>
    <button class="refresh" onclick="loadSummary()">üîÑ Refresh Progress</button>
  </div>

  <script>
    const BASE_URL = "http://localhost:8000"; // Change if deployed

    // Get patient ID from URL parameter (support multiple parameter names)
    function getPatientIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Try different parameter names that might be used
      const possibleParamNames = ['id', 'patient_id', 'pid'];
      for (const paramName of possibleParamNames) {
        const paramValue = urlParams.get(paramName);
        if (paramValue) {
          // Validate that it looks like a UUID
          if (isValidUUID(paramValue)) {
            return paramValue;
          }
        }
      }
      
      // If no parameter found, check if there's a path-based ID
      const pathParts = window.location.pathname.split('/');
      if (pathParts.length > 2) {
        const lastPart = pathParts[pathParts.length - 1];
        // Only use as ID if it looks like a UUID and is not the filename
        if (lastPart && lastPart.length > 10 && lastPart !== 'patient.html' && isValidUUID(lastPart)) {
          return lastPart;
        }
      }
      
      return null;
    }
    
    // Validate UUID format
    function isValidUUID(uuid) {
      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      return uuidRegex.test(uuid);
    }

    // Show message to user
    function showMessage(message, isSuccess = true) {
      const messageArea = document.getElementById("messageArea");
      messageArea.innerHTML = `<div class="${isSuccess ? 'success' : 'error'}">${message}</div>`;
      
      // Auto-hide success messages after 3 seconds
      if (isSuccess) {
        setTimeout(() => {
          messageArea.innerHTML = '';
        }, 3000);
      }
    }

    // Debug function to show URL information
    function debugUrlInfo() {
      const url = window.location.href;
      const search = window.location.search;
      const params = new URLSearchParams(search);
      
      console.log("Current URL:", url);
      console.log("Search parameters:", search);
      console.log("All parameters:", Object.fromEntries(params.entries()));
      
      return {
        url: url,
        search: search,
        params: Object.fromEntries(params.entries())
      };
    }

    // Initialize the page
    window.onload = function() {
      // Debug URL information
      const urlInfo = debugUrlInfo();
      
      const patientId = getPatientIdFromUrl();
      if (patientId) {
        document.getElementById("patientIdDisplay").textContent = `ID: ${patientId}`;
        loadPatient(patientId);
      } else {
        // Show debug information to help user
        const debugInfo = `
          <p><strong>No patient ID provided in URL.</strong></p>
          <p>Please use a valid patient link generated by the doctor dashboard.</p>
          <p><strong>Expected URL format:</strong></p>
          <p><code>http://localhost:8000/frontend/patient.html?id=PATIENT_UUID</code></p>
        `;
        showMessage(debugInfo, false);
        
        // Show manual input option
        document.getElementById("manualInput").style.display = "block";
      }
    }

    // Function to load patient data manually
    function loadPatientManually() {
      const patientId = document.getElementById("manualPatientId").value.trim();
      if (!patientId) {
        showMessage("Please enter a Patient ID", false);
        return;
      }
      
      document.getElementById("patientIdDisplay").textContent = `ID: ${patientId}`;
      loadPatient(patientId);
    }

    async function loadPatient(patientId) {
      if (!patientId) {
        showMessage("Patient ID is required", false);
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}/api/patient/${patientId}`);
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.detail || "Failed to load patient data");
        }

        document.getElementById("prescriptionsCard").style.display = "block";
        document.getElementById("summaryCard").style.display = "block";

        document.getElementById("patientInfo").innerHTML = `
          <p><b>Name:</b> ${data.data.patient.name}</p>
          <p><b>Condition:</b> ${data.data.patient.condition}</p>
          <p><b>Age:</b> ${data.data.patient.age}</p>
        `;

        const prescriptionsDiv = document.getElementById("prescriptions");
        prescriptionsDiv.innerHTML = "";
        
        if (data.data.treatments.length === 0) {
          prescriptionsDiv.innerHTML = "<p>No prescriptions found.</p>";
        } else {
          data.data.treatments.forEach(t => {
            const div = document.createElement("div");
            div.className = "prescription-item";
            
            // Create schedule days display
            let scheduleInfo = "";
            if (t.schedule_days && t.schedule_days.length > 0) {
              scheduleInfo = `<p><strong>Scheduled Days:</strong> ${t.schedule_days.join(", ")}</p>`;
            }
            
            // Create today's date for default logging
            const today = new Date().toISOString().split('T')[0];
            
            div.innerHTML = `
              <p><b>${t.medication}</b> (${t.dosage}, ${t.frequency})</p>
              ${scheduleInfo}
              <div style="margin: 10px 0;">
                <label>Date: <input type="date" id="date-${t.id}" value="${today}" style="margin-right: 10px;"></label>
                <button class="taken" onclick="logDose('${patientId}','${t.medication}','Taken', '${t.id}')">‚úÖ Taken</button>
                <button class="missed" onclick="logDose('${patientId}','${t.medication}','Missed', '${t.id}')">‚ùå Missed</button>
              </div>
            `;
            prescriptionsDiv.appendChild(div);
          });
        }

        loadSummary(patientId);
      } catch (error) {
        showMessage("Error loading patient data: " + error.message, false);
        console.error(error);
      }
    }

    async function logDose(patientId, med, status, treatmentId) {
      try {
        // Get the date from the input field for this treatment
        const dateInput = document.getElementById(`date-${treatmentId}`);
        const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        
        showMessage(`Logging dose as ${status} for ${date}...`, true);
        
        const res = await fetch(`${BASE_URL}/api/log_dose`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            patient_id: patientId, 
            medication: med, 
            status: status,
            date: date
          })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          showMessage(`Dose logged successfully as ${status} for ${date}!`, true);
          loadSummary(patientId);
        } else {
          throw new Error(data.detail || "Error logging dose.");
        }
      } catch (error) {
        showMessage("Error logging dose: " + error.message, false);
        console.error(error);
      }
    }

    async function loadSummary(patientId) {
      if (!patientId) return;
      
      try {
        const res = await fetch(`${BASE_URL}/api/summary/${patientId}`);
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.detail || "Failed to load summary");
        }

        document.getElementById("adherence").innerHTML = `<b>Adherence:</b> ${data.data.adherence}%`;
        
        // Display risk with appropriate color
        let riskClass = "";
        if (data.data.risk_label === "Low") riskClass = "risk-low";
        else if (data.data.risk_label === "Medium") riskClass = "risk-medium";
        else if (data.data.risk_label === "High") riskClass = "risk-high";
        
        document.getElementById("risk").innerHTML = `<b>Risk Level:</b> <span class="${riskClass}">${data.data.risk_label}</span>`;
        document.getElementById("feedback").innerHTML = `<b>üí¨ Motivational Message:</b> ${data.data.feedback}`;
      } catch (error) {
        showMessage("Error loading summary: " + error.message, false);
        console.error(error);
      }
    }

    // TODO: Integrate Web NFC here to auto-fetch patient ID and call loadPatient()
  </script>
</body>
</html>